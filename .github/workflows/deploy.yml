name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Stop the script if any command fails
            set -e

            echo "ðŸš€ Starting Deployment..."

            # 1. Navigate to project folder
            cd ~/Hotel_Booking_Web

            # 2. Force Git to exactly match the repository
            # (Fixes issues where local changes block updates)
            git fetch --all
            git reset --hard origin/main

            # 3. Stop running containers
            docker compose -f docker-compose.prod.yml down

            # 4. Force Rebuild from Source (Crucial for updates)
            # --no-cache: Forces Docker to ignore old versions and rebuild fresh
            docker compose -f docker-compose.prod.yml build --no-cache

            # 5. Start the containers
            docker compose -f docker-compose.prod.yml up -d --force-recreate

            # 6. Cleanup to save space
            docker image prune -f
            
            echo "âœ… Deployment Successful"